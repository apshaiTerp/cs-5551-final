<!DOCTYPE html>
<html lang="en">
  <head>

    <script type='text/javascript'>//<![CDATA[ 
      var userName = sessionStorage.getItem("userName");
      var userRole = sessionStorage.getItem("userRole");
      var userID   = sessionStorage.getItem("userID");

      if (userName == null) {
        window.location = "../login.html";
      }
      if (userRole != "User") {
        window.location = "../login.html";
      }
      if (userID == null) {
        window.location = "../login.html";
      }
    </script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/scute.ico">

    <title>Terrapin Collection Manager</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/jquery-ui.css" rel="stylesheet">
    <link href="css/bootstrap-editable.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/apshai.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Fredericka+the+Great|Architects+Daughter|Ubuntu' rel='stylesheet' type='text/css'>
  </head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand">Terrapin Collection Manager</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="./home.html">Home</a></li>
            <li><a href="./collection.html">Collection</a></li>
            <li><a href="./recommend.html">Recommend</a></li>
            <li><a href="./wishlist.html">Wishlist</a></li>
            <li><a href="./about.html">About</a></li>
          </ul>

          <form class="navbar-form navbar-right">
            <a href="../index.html" id="logout-button" class="btn btn-success" onclick="logOutFunction()" type="button">Log Out</a>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="bg-game"></div>
    <div class="jumbotron">
      <div class="container">
        <h3 align="center">Let's take a look at this Game a little closer</h3>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-sm-12 col-md-12">
          <div class="thumbnail">
            <div class="input-group col-md-12 col-sm-12 col-xs-12">
              <input id="game-auto-complete" class="form-control" type="text" placeholder="Search for Game">
              <span class="input-group-btn">
                <button class="btn btn-primary" type="button" id="game-search-button" onclick="searchFunction()">Search</button>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row" style="display:flex; flex-wrap: wrap">
        <div class="col-xs-12">
          <div class="panel panel-primary">
            <div class="panel-heading panel-title" id="title-heading">Game Name
              <a href="#" id="wish-button" class="btn btn-sm btn-primary pull-right" onclick="addToCollectionFunction()" role="button">Add to Wishlist</a>
              <a href="#" id="add-button" class="btn btn-sm btn-primary pull-right" onclick="addToWishlistFunction()" role="button">Add to Collection</a>
            </div>
          </div>
          <div class="panel-body">
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid" style="display:flex; flex-wrap: wrap">
      <div class="row" style="display:flex; flex-wrap: wrap">
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
          <div class="panel panel-primary">
            <div id="game-heading" class="panel-heading">
              <h4 class="panel-title"><a data-toggle="collapse" data-target="#game-panel" href="#game-panel" class="collapsed">Game Information</a></h4>
            </div>
          </div>
          <div id="game-panel" class="panel-collapse collapse in">
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12 col-md-12">
                  <div class="thumbnail">
                    <ul class="list-group">
                      <li class="list-group-item">
                        <strong>Game ID</strong>
                        <span class="label label-default label-right" id="gameid-label">---</span>
                      </li>
                      <li class="list-group-item">
                        <strong>BoardGameGeek ID</strong>
                        <span class="label label-default label-right" id="bggid-label">---</span>
                      </li>
                      <li class="list-group-item">
                        <strong>Primary Publisher</strong>
                        <span class="label label-default label-right" id="ppub-label">---</span>
                      </li>
                      <li class="list-group-item">
                        <strong>Game Type</strong>
                        <span class="label label-default label-right" id="type-label">---</span>
                      </li>
                      <li class="list-group-item">
                        <strong>Player Count</strong>
                        <span class="label label-default label-right" id="players-label"><a href="#" id="players-edit">---</a></span>
                      </li>
                      <li class="list-group-item">
                        <strong>Playing Time</strong>
                        <span class="label label-default label-right" id="time-label">---</span>
                      </li>
                      <li class="list-group-item">
                        <strong>Publishers</strong>
                        <span class="label label-default label-right" id="pubs-label">---</span>
                      </li>
                      <li class="list-group-item">
                        <strong>Designers</strong>
                        <span class="label label-default label-right" id="des-label">---</span>
                      </li>
                      <li class="list-group-item">
                        <strong>Categories</strong>
                        <span class="label label-default label-right" id="cat-label">---</span>
                      </li>
                      <li class="list-group-item">
                        <strong>Mechanisms</strong>
                        <span class="label label-default label-right" id="mech-label">---</span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-5 col-lg-5">
          <div class="panel panel-primary">
            <div class="panel-heading">
              <h4 id="art-heading" class="panel-title"><a data-toggle="collapse" data-target="#art-panel" href="#art-panel" class="collapsed">Game Art</a></h4>
            </div>
          </div>
          <div id="art-panel" class="panel-collapse collapse in">
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12 col-md-12">
                  <div class="thumbnail">
                    <div id="game-image">
                      <img src="./img/dnf.png" alt="./img/dnf.png" style="max-height: 500px;">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
       <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
          <div class="panel panel-primary">
            <div class="panel-heading">
              <h4 id="desc-heading" class="panel-title"><a data-toggle="collapse" data-target="#desc-panel" href="#desc-panel" class="collapsed">Game Description</a></h4>
            </div>
          </div>
          <div id="desc-panel" class="panel-collapse collapse in">
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12 col-md-12">
                  <div class="thumbnail">
                    <ul class="list-group">
                      <li class="list-group-item" id="desc-text">
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
          <div class="panel panel-primary">
            <div class="panel-heading">
              <h4 id="expansion-heading" class="panel-title"><a data-toggle="collapse" data-target="#exp-panel" href="#exp-panel" class="collapsed" id="exp-header-text">Available Expansions</a></h4>
            </div>
          </div>
          <div id="exp-panel" class="panel-collapse collapse in">
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12 col-md-12">
                  <ul class="list-group" id="exp-list-area">
                    <li class="list-group-item">

                      <div class="media">
                        <div class="media-left">
                          <img class="media-object" id="thumbnail-image" src="img/question.png" alt="Nope" style="max-height: 64px; max-width: 64px;" />
                        </div>
                        <div class="media-body" id="game-body">
                          <h4 class="media-heading"></h4>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
          <div class="panel panel-primary">
            <div class="panel-heading">
              <h4 id="csi-heading" class="panel-title"><a data-toggle="collapse" data-target="#csi-panel" href="#csi-panel" class="collapsed" id="csi-header-text">CoolStuffInc Price Data</a></h4>
            </div>
          </div>
          <div id="csi-panel" class="panel-collapse collapse in">
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12 col-md-12">
                  <ul class="list-group" id="csi-list-area">
                    <li class="list-group-item">

                      <div class="media">
                        <div class="media-left">
                          <img class="media-object" id="thumbnail-image" src="img/question.png" alt="Nope" style="max-height: 64px; max-width: 64px;" />
                        </div>
                        <div class="media-body" id="game-body">
                          <h4 class="media-heading"></h4>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
          <div class="panel panel-primary">
            <div class="panel-heading">
              <h4 id="mm-heading" class="panel-title"><a data-toggle="collapse" data-target="#mm-panel" href="#mm-panel" class="collapsed" id="mm-header-text">MiniatureMarket Price Data</a></h4>
            </div>
          </div>
          <div id="mm-panel" class="panel-collapse collapse in">
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12 col-md-12">
                  <ul class="list-group" id="mm-list-area">
                    <li class="list-group-item">

                      <div class="media">
                        <div class="media-left">
                          <img class="media-object" id="thumbnail-image" src="img/question.png" alt="Nope" style="max-height: 64px; max-width: 64px;" />
                        </div>
                        <div class="media-body" id="game-body">
                          <h4 class="media-heading"></h4>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div id="success-modal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Success!</h4>
          </div>
          <div class="modal-body">
            <p>The Game has been added to your Collection!</p>
          </div>
          <div class="model-footer">
            <button type="button" class="btn btn-success btn-pad pull-right" data-dismiss="modal">
              <span class="glyphicon glyphicon-thumbs-up"></span>OK
            </button>
            <br><br>
          </div>
        </div>
      </div>
    </div>
    <div id="success-modal2" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Success!</h4>
          </div>
          <div class="modal-body">
            <p>The Game has been added to your Wishlist!</p>
          </div>
          <div class="model-footer">
            <button type="button" class="btn btn-success btn-pad pull-right" data-dismiss="modal">
              <span class="glyphicon glyphicon-thumbs-up"></span>OK
            </button>
            <br><br>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <hr>
      <footer>
        <p>&copy; Terrapin Game Collection Manager 2015 - A Project for UMKC Class CS 5551</p>
      </footer>
    </div> <!-- /container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery-1.11.2.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/bootstrap-editable.js"></script>
    <script src="js/jquery-ui.js"></script>

    <script type='text/javascript'>//<![CDATA[ 
      
      function logOutFunction() {
        sessionStorage.clear();
        localStorage.clear();
      };

      function imgError(image) {
        image.onerror = "";
        image.src = "./img/question.png";
        return true;
      }

      function addToCollectionFunction() {
        var gameID = sessionStorage.getItem("searchGameID");
        var userID = sessionStorage.getItem("userID");

        //console.log("I need to add gameID " + gameID + " to userID " + userID + "'s Collection");

        var jsonBody = '{ "gameID": "' + gameID + '", "userID": "' + userID + '" }';
        $.ajax ({
          type: 'POST',
          url: 'http://107.188.249.238:8080/ac-games-restservice-spring-1.0/collection/add',
          data: jsonBody,
          contentType: "application/json",
          dataType: 'json',
          success: function(data) {
            var messageType = data['messageType'];
            var errorType   = data['errorType'];

            if (messageType == "Operation Successful") {
              var message = data['message'];
              $('#success-modal').modal('show');
            } else {
              var errorMessage = data['errorMessage'];
              alert(errorType + ": " + errorMessage);
            }
          },
          error: function(jqXHR, textStatus, errorThrown) {
            alert('An Unknown Error Occured During Add Task.  Please Try Again Later.');
          }

        });
      };

      function addToWishlistFunction() {
        var gameID = sessionStorage.getItem("searchGameID");
        var userID = sessionStorage.getItem("userID");

        //console.log("I need to add gameID " + gameID + " to userID " + userID + "'s Wishlist");

        var jsonBody = '{ "gameID": "' + gameID + '", "userID": "' + userID + '" }';
        $.ajax ({
          type: 'POST',
          url: 'http://107.188.249.238:8080/ac-games-restservice-spring-1.0/wishlist',
          data: jsonBody,
          contentType: "application/json",
          dataType: 'json',
          success: function(data) {
            var messageType = data['messageType'];
            var errorType   = data['errorType'];

            if (messageType == "Operation Successful") {
              var message = data['message'];
              $('#success-modal2').modal('show');
            } else {
              var errorMessage = data['errorMessage'];
              alert(errorType + ": " + errorMessage);
            }
          },
          error: function(jqXHR, textStatus, errorThrown) {
            alert('An Unknown Error Occured During Add Task.  Please Try Again Later.');
          }

        });
      };

      function populateGameFieldsFunction() {
        var gameID = sessionStorage.getItem("searchGameID");
        if (gameID == null) {
          console.log("I had no gameID.");
          return;
        }

        var gameURL = "http://107.188.249.238:8080/ac-games-restservice-spring-1.0/game?gameid=" + gameID;
        $.getJSON( gameURL, { format: 'json'} )
            .done(function(data) {  

              var name       = data['name'];
              var yearPub    = data['yearPublished'];
              var bggID      = data['bggID'];
              var primaryPub = data['primaryPublisher'];
              var type       = data['gameType'];
              var minPlayers = data['minPlayers'];
              var maxPlayers = data['maxPlayers'];
              var minTime    = data['minPlayingTime'];
              var maxTime    = data['maxPlayingTime'];
              var publishers = data['publishers'];
              var designers  = data['designers'];
              var categories = data['categories'];
              var mechanisms = data['mechanisms'];

              var gameImage  = data['imageURL'];

              var gameDesc   = data['description'];

              var parentGame = data['parentGameID'];
              var expansions = data['expansionIDs'];

              if ((yearPub == null) || (yearPub == -1)) {
                var titleHeader = name + '<a href="#" id="wish-button" class="btn btn-sm btn-primary pull-right" onclick="addToWishlistFunction()" role="button">Add to Wishlist</a>' + '<a href="#" id="add-button" class="btn btn-sm btn-primary pull-right" onclick="addToCollectionFunction()" role="button">Add to Collection</a>';
                document.getElementById("title-heading").innerHTML = titleHeader;
              } else {
                var titleHeader = name + " (" + yearPub + ")" + '<a href="#" id="wish-button" class="btn btn-sm btn-primary pull-right" onclick="addToWishlistFunction()" role="button">Add to Wishlist</a>' + '<a href="#" id="add-button" class="btn btn-sm btn-primary pull-right" onclick="addToCollectionFunction()" role="button">Add to Collection</a>';
                document.getElementById("title-heading").innerHTML = titleHeader;
              }

              document.getElementById("gameid-label").innerHTML = gameID;
              document.getElementById("bggid-label").innerHTML  = bggID;
              document.getElementById("ppub-label").innerHTML   = primaryPub;
              document.getElementById("type-label").innerHTML   = type;

              if (minPlayers != maxPlayers) {
                var playerText = "" + minPlayers + " - " + maxPlayers + " Players";
                document.getElementById("players-label").innerHTML = playerText;
              } else {
                if (minPlayers == -1) {
                  document.getElementById("players-label").innerHTML = "Unknown";
                } else {
                  document.getElementById("players-label").innerHTML = "" + minPlayers + " Players";
                }
              }

              if (minTime != maxTime) {
                var timeText = "" + minTime + " - " + maxTime + " Minutes";
                document.getElementById("time-label").innerHTML = timeText;
              } else {
                if (minTime == -1) {
                  document.getElementById("time-label").innerHTML = "Unknown";
                } else {
                  document.getElementById("time-label").innerHTML = "" + minTime + " Minutes";
                }
              }

              var designerText = "";
              if (designers.length == 0) {
                designerText = "---";
              } else {
                if (designers.length == 1) {
                  designerText = designers[0];
                } else {
                  designerText = designers[0] + ', ';
                }
                for (var pos = 1; pos < designers.length; pos++) {
                  designerText = designerText + designers[pos];
                  if (pos < (designers.length - 1)) {
                    designerText = designerText + ", ";
                  }
                  if (((pos % 2) == 1) && (pos < (designers.length - 1))) {
                    designerText = designerText + "<br>";
                  }
                }
              }

              var publisherText = "";
              if (publishers.length < 1) {
                publisherText = "---";
              } else {
                if (publishers.length == 1) {
                  publisherText = publishers[0];
                } else {
                  publisherText = publishers[0] + ', ';
                }
                for (var pos2 = 1; pos2 < publishers.length; pos2++) {
                  publisherText = publisherText + publishers[pos2];
                  if (pos2 < (publishers.length - 1)) {
                    publisherText = publisherText + ", ";
                  }
                  if (((pos2 % 2) == 1) && (pos2 < (publishers.length - 1))) {
                    publisherText = publisherText + "<br>";
                  }
                }
              }

              var categoryText = "";
              if (categories.length == 0) {
                categoryText = "---";
              } else {
                if (categories.length == 1) {
                  categoryText = categories[0];
                } else {
                  categoryText = categories[0] + ', ';
                }
                for (var pos = 1; pos < categories.length; pos++) {
                  categoryText = categoryText + categories[pos];
                  if (pos < (categories.length - 1)) {
                    categoryText = categoryText + ", ";
                  }
                  if (((pos % 2) == 1) && (pos < (categories.length - 1))) {
                    categoryText = categoryText + "<br>";
                  }
                }
              }

              var mechanismText = "";
              if (mechanisms.length < 1) {
                mechanismText = "---";
              } else {
                if (mechanisms.length == 1) {
                  mechanismText = mechanisms[0];
                } else {
                  mechanismText = mechanisms[0] + ', ';
                }
                for (var pos2 = 1; pos2 < mechanisms.length; pos2++) {
                  mechanismText = mechanismText + mechanisms[pos2];
                  if (pos2 < (mechanisms.length - 1)) {
                    mechanismText = mechanismText + ", ";
                  }
                  if (((pos2 % 2) == 1) && (pos2 < (mechanisms.length - 1))) {
                    mechanismText = mechanismText + "<br>";
                  }
                }
              }

              document.getElementById("pubs-label").innerHTML = publisherText;
              document.getElementById("des-label").innerHTML  = designerText;
              document.getElementById("cat-label").innerHTML  = categoryText;
              document.getElementById("mech-label").innerHTML = mechanismText;

              if (gameImage == null) {
                document.getElementById("game-image").innerHTML = '<img src="./img/dnf.png" alt="No Image Found for this Game" style="max-height: 500px;">';
              } else {
                document.getElementById("game-image").innerHTML = '<img src="' + gameImage + '" alt="./img/dnf.png" style="max-height: 500px;">';
              }

              gameDesc = gameDesc.replace("\n", "<br>");
              document.getElementById("desc-text").innerHTML = gameDesc;

              //Handle the Flex for Expansion or Base
              if (type == "EXPANSION") {
                document.getElementById("exp-header-text").innerHTML = "Parent Game";

                //console.log("I'm in the expansion branch...");

                if (parentGame == -1) {
                  console.log("The parentGame was == -1");

                  document.getElementById("exp-list-area").innerHTML = '<li class="list-group-item">Unable to link to Parent Game</li>'
                } else {
                  //console.log("Attempting to look up parentGame: " + parentGame);

                  var parentURL = "http://107.188.249.238:8080/ac-games-restservice-spring-1.0/auto?source=game&value=<" + parentGame + ">";
                  //var parentURL = "http://localhost:8080/auto?source=game&value=<" + parentGame + ">;

                  console.log("parentURL: " + parentURL);

                  $.getJSON( parentURL, { format: 'json'} )
                      .done(function(data) {

                        //Store the object in memory to retrieve later
                        var parentData      = data[0];
                        var parentGameID    = parentData['sourceID'];
                        var parentGameThumb = parentData['thumbnailURL'];
                        var parentDisplay   = parentData['displayString'];

                        if (parentGameThumb == null) {
                          parentGameThumb = './img/question.png';
                        }

                        //Note:  Somewhere in here we need to add a button as well.
                        var parentGameText = '<li class="list-group-item"><div class="media"><div class="media-left"><img class="media-object" id="thumbnail-image" src="' + parentGameThumb + '" onerror="imgError(this);" style="max-height: 64px; max-width: 64px;"/></div><div class="media-body"><h4 class="media-heading">' + parentDisplay + '<a id="vparent-button" class="btn btn-sm btn-primary pull-right" role="button">View Game</a></h4>Game ID: ' + parentGameID + '</div></div></li>';

                        document.getElementById("exp-list-area").innerHTML = parentGameText;

                        document.getElementById("vparent-button").onclick = function() {
                          sessionStorage.setItem("searchGameID", parentGameID);
                          populateGameFieldsFunction();
                        };

                      });
                }
              } else {
                //console.log("This is a Base or Collectible Game...");

                //This is not an expansion, it's a BASE or COLLECTIBLE game...
                if (expansions == null) {
                  document.getElementById("exp-header-text").innerHTML = "Game Expansions (0)";
                  document.getElementById("exp-list-area").innerHTML = '<li class="list-group-item">There are no expansions for this game.</li>'
                } else if (expansions.length == 0) {
                  document.getElementById("exp-header-text").innerHTML = "Game Expansions (0)";
                  document.getElementById("exp-list-area").innerHTML = '<li class="list-group-item">There are no expansions for this game.</li>'
                } else {
                  document.getElementById("exp-header-text").innerHTML = "Game Expansions (" + expansions.length + ")";

                  //We have at least one expansion, we now have to render it
                  //First we need to build a string to submit for our call.
                  var expIDString = "<" + expansions[0];

                  for (expLoop = 1; expLoop < expansions.length; expLoop++) {
                    expIDString = expIDString + "," + expansions[expLoop];
                  }
                  expIDString = expIDString + ">";

                  //console.log("The expIDString I want to look up is: " + expIDString);

                  var expURL = "http://107.188.249.238:8080/ac-games-restservice-spring-1.0/auto?source=game&value=<" + expIDString + ">";
                  //var expURL = "http://localhost:8080/auto?source=game&value=<" + expIDString + ">;

                  console.log("The expURL: " + expURL);

                  $.getJSON( expURL, { format: 'json'} )
                      .done(function(data) {

                        //console.log("How many expansion games did I get back: " + data.length);

                        var masterText = "";

                        for (expLoop = 0; expLoop < data.length; expLoop++) {
                          var curExp = data[expLoop];

                          //Store the object in memory to retrieve later
                          var expGameID    = curExp['sourceID'];
                          var expGameThumb = curExp['thumbnailURL'];
                          var expDisplay   = curExp['displayString'];

                          if (expGameThumb == null) {
                            expGameThumb = './img/question.png';
                          }

                          //Note:  Somewhere in here we need to add a button as well.
                          var expGameText = '<li class="list-group-item"><div class="media"><div class="media-left"><img class="media-object" id="thumbnail-image" src="' + expGameThumb + '" onerror="imgError(this);" style="max-height: 64px; max-width: 64px;"/></div><div class="media-body"><h4 class="media-heading">' + expDisplay + '<a id="' + expGameID + '-button" class="btn btn-sm btn-primary pull-right" role="button">View Game</a></h4>Game ID: ' + expGameID + '</div></div></li>';

                          masterText = masterText + expGameText;
                        }

                        //console.log("About to add the full masterText block");

                        document.getElementById("exp-list-area").innerHTML = masterText;                        

                        //Now we need to loop back through and create button onclick functions for each element
                        for (expLoop = 0; expLoop < data.length; expLoop++) {
                          var curExp = data[expLoop];

                          var expGameID  = curExp['sourceID'];

                          eval('document.getElementById("' + expGameID  + '-button").onclick = function() { sessionStorage.setItem("searchGameID", ' + expGameID + '); populateGameFieldsFunction(); };');
                        }
                      });
                }//end else we have at least one expansion

              }//end else it's a base or collectible game

            }); //End Json call

            //Now we need to call out and get the price data
            var csiPriceURL = "http://107.188.249.238:8080/ac-games-restservice-spring-1.0/gamereltn?gameid=" + gameID + "&vendor=csi";
            //var csiPriceURL = "http://localhost:8080/ac-games-restservice-spring-1.0/gamereltn?gameid=" + gameID + "&vendor=csi";

            $.getJSON( csiPriceURL, { format: 'json'} )
                .done(function(data) {

                  if ((data != null) && (data.length > 0)) {
                    var csiText = "";

                    for (csiLoop = 0; csiLoop < data.length; csiLoop++) {
                      var csiData = data[csiLoop];

                      var csiTitle = csiData['titleDisplay'];
                      var csiPrice = csiData['priceDisplay'];
                      var csiLink  = csiData['linkURL'];
                      var csiThumb = csiData['thumbnailURL'];

                      if (csiThumb == null) {
                        csiThumb = './img/question.png';
                      }

                      var csiGameText = '<li class="list-group-item"><div class="media"><div class="media-left"><img class="media-object" id="thumbnail-image" src="' + csiThumb + '" onerror="imgError(this);" style="max-height: 64px; max-width: 64px;"/></div><div class="media-body"><h4 class="media-heading">' + csiTitle + '<a id="csi-' + csiLoop + '-button" class="btn btn-sm btn-primary pull-right" role="button">View at CoolStuffInc</a></h4>' + csiPrice + '</div></div></li>';

                      csiText = csiText + csiGameText;
                    }

                    document.getElementById("csi-list-area").innerHTML = csiText;                        

                    //Now we need to turn on the buttons
                    for (csiLoop = 0; csiLoop < data.length; csiLoop++) {
                      var csiData = data[csiLoop];

                      var csiLink  = csiData['linkURL'];

                      eval('document.getElementById("csi-' + csiLoop  + '-button").onclick = function() { window.open("' + csiLink + '"); };');
                    }
                  } else {
                    document.getElementById("csi-list-area").innerHTML = '<li class="list-group-item">No CoolStuffInc Titles have been linked to this Game</li>';
                  }
                });

            var mmPriceURL = "http://107.188.249.238:8080/ac-games-restservice-spring-1.0/gamereltn?gameid=" + gameID + "&vendor=mm";
            //var mmPriceURL = "http://localhost:8080/ac-games-restservice-spring-1.0/gamereltn?gameid=" + gameID + "&vendor=mm";

            $.getJSON( mmPriceURL, { format: 'json'} )
                .done(function(data) {

                  if ((data != null) && (data.length > 0)) {
                    var mmText = "";

                    for (mmLoop = 0; mmLoop < data.length; mmLoop++) {
                      var mmData = data[mmLoop];

                      var mmTitle = mmData['titleDisplay'];
                      var mmPrice = mmData['priceDisplay'];
                      var mmLink  = mmData['linkURL'];
                      var mmThumb = mmData['thumbnailURL'];

                      if (mmThumb == null) {
                        mmThumb = './img/question.png';
                      }

                      var mmGameText = '<li class="list-group-item"><div class="media"><div class="media-left"><img class="media-object" id="thumbnail-image" src="' + mmThumb + '" onerror="imgError(this);" style="max-height: 64px; max-width: 64px;"/></div><div class="media-body"><h4 class="media-heading">' + mmTitle + '<a id="mm-' + mmLoop + '-button" class="btn btn-sm btn-primary pull-right" role="button">View at MinatureMarket</a></h4>' + mmPrice + '</div></div></li>';

                      mmText = mmText + mmGameText;
                    }

                    document.getElementById("mm-list-area").innerHTML = mmText;                        

                    //Now we need to turn on the buttons
                    for (mmLoop = 0; mmLoop < data.length; mmLoop++) {
                      var mmData = data[mmLoop];

                      var mmLink  = mmData['linkURL'];

                      eval('document.getElementById("mm-' + mmLoop  + '-button").onclick = function() { window.open("' + mmLink + '"); };');
                    }
                  } else {
                    document.getElementById("mm-list-area").innerHTML = '<li class="list-group-item">No MiniatureMarket Titles have been linked to this Game</li>';
                  }
                });
      };

      populateGameFieldsFunction();

      function setupAutoCompleteFunction() {
        $('#game-auto-complete').prop('disabled', true);
        $('#game-search-button').prop('disabled', true);

        var gameAutoCompList = JSON.parse(sessionStorage.getItem("gameAutoCompList"));

        $('#game-auto-complete').autocomplete({
          source: gameAutoCompList,
          minLength: 3
        });

        $('#game-auto-complete').prop('disabled', false);
        $('#game-auto-complete').on("autocompleteselect", function(event, ui) {
          var currentItem = ui.item.value;

          //console.log("The value I'm trying to look up is: " + currentItem);
          
          //Now we want to do the quick game lookup
          var gameCompactURL = "http://107.188.249.238:8080/ac-games-restservice-spring-1.0/auto?source=game&value=" + currentItem;
          //var gameCompactURL = "http://localhost:8080/auto?source=game&value=" + currentItem;

          console.log("The URL we are about to run is: " + gameCompactURL);

          $.getJSON( gameCompactURL, { format: 'json'} )
              .done(function(data) {  

                //Store the object in memory to retrieve later
                var gameID    = data['sourceID'];
                //var gameThumb = data['thumbnailURL'];
                //var display   = data['displayString'];

                sessionStorage.setItem("searchGameID", gameID);

                $('#game-search-button').prop('disabled', false);
              })              
              .fail(function() {
                alert("I could not find the auto game info!");

                localStorage.removeItem("searchGameID");

                $('#game-search-button').prop('disabled', true);
              });
        });

      };

      setupAutoCompleteFunction();

      function searchFunction() {
        var searchGameID = sessionStorage.getItem("searchGameID");
        if (searchGameID == null) {
          console.log("I could not find the searchGameID");
          return;
        }

        console.log("Searching for gameID " + searchGameID);

        populateGameFieldsFunction();
      };

    </script>
  </body>
</html>
